<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¸…é™¤ç¼“å­˜ - Eè§†ç•Œ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
        }

        .container {
            text-align: center;
            padding: 40px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            backdrop-filter: blur(10px);
            max-width: 500px;
        }

        h1 {
            font-size: 28px;
            margin-bottom: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        p {
            color: #aaa;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .status {
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            margin: 20px 0;
            font-family: monospace;
            font-size: 14px;
            text-align: left;
            max-height: 200px;
            overflow-y: auto;
        }

        .status .success {
            color: #46d369;
        }

        .status .info {
            color: #60a5fa;
        }

        .status .error {
            color: #ef4444;
        }

        .btn {
            display: inline-block;
            padding: 15px 40px;
            background: linear-gradient(135deg, #e50914 0%, #b20710 100%);
            color: white;
            border: none;
            border-radius: 30px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .btn:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(229, 9, 20, 0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #374151 0%, #1f2937 100%);
            margin-top: 15px;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #fff;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
            vertical-align: middle;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ğŸ§¹ æ¸…é™¤ç½‘ç«™ç¼“å­˜</h1>
        <p>å¦‚æœç½‘ç«™æ˜¾ç¤ºå¼‚å¸¸æˆ–ç‰ˆæœ¬è¿‡æ—§ï¼Œç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ¸…é™¤æ‰€æœ‰ç¼“å­˜æ•°æ®ã€‚æ¸…é™¤åå°†è‡ªåŠ¨è·³è½¬åˆ°ä¸»é¡µã€‚</p>

        <div class="status" id="status">
            <div class="info">ç­‰å¾…æ“ä½œ...</div>
        </div>

        <button class="btn" id="clearBtn" onclick="clearAllCache()">
            ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰ç¼“å­˜
        </button>

        <br>

        <a href="/" class="btn btn-secondary">â†©ï¸ è¿”å›ä¸»é¡µ</a>
    </div>

    <script>
        function log(msg, type) {
            var status = document.getElementById('status');
            var div = document.createElement('div');
            div.className = type || 'info';
            div.textContent = '> ' + msg;
            status.appendChild(div);
            status.scrollTop = status.scrollHeight;
        }

        async function clearAllCache() {
            var btn = document.getElementById('clearBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span>æ­£åœ¨æ¸…é™¤...';

            document.getElementById('status').innerHTML = '';

            try {
                // 1. æ³¨é”€æ‰€æœ‰ Service Worker
                log('æ­£åœ¨æ³¨é”€ Service Worker...', 'info');
                if ('serviceWorker' in navigator) {
                    var registrations = await navigator.serviceWorker.getRegistrations();
                    for (var reg of registrations) {
                        await reg.unregister();
                        log('å·²æ³¨é”€: ' + reg.scope, 'success');
                    }
                    if (registrations.length === 0) {
                        log('æ²¡æœ‰æ‰¾åˆ° Service Worker', 'info');
                    }
                }

                // 2. åˆ é™¤æ‰€æœ‰ç¼“å­˜
                log('æ­£åœ¨åˆ é™¤ç¼“å­˜å­˜å‚¨...', 'info');
                if ('caches' in window) {
                    var cacheNames = await caches.keys();
                    for (var name of cacheNames) {
                        await caches.delete(name);
                        log('å·²åˆ é™¤ç¼“å­˜: ' + name, 'success');
                    }
                    if (cacheNames.length === 0) {
                        log('æ²¡æœ‰æ‰¾åˆ°ç¼“å­˜', 'info');
                    }
                }

                // 3. æ¸…é™¤ localStorage
                log('æ­£åœ¨æ¸…é™¤æœ¬åœ°å­˜å‚¨...', 'info');
                var swKeys = Object.keys(localStorage).filter(function (k) {
                    return k.startsWith('sw_');
                });
                swKeys.forEach(function (k) { localStorage.removeItem(k); });
                log('å·²æ¸…é™¤ ' + swKeys.length + ' é¡¹ SW ç›¸å…³å­˜å‚¨', 'success');

                // 4. å®Œæˆ
                log('âœ… æ‰€æœ‰ç¼“å­˜å·²æ¸…é™¤ï¼', 'success');
                log('3 ç§’åè·³è½¬åˆ°ä¸»é¡µ...', 'info');

                btn.innerHTML = 'âœ… æ¸…é™¤å®Œæˆ';

                setTimeout(function () {
                    window.location.href = '/?v=' + Date.now();
                }, 3000);

            } catch (e) {
                log('âŒ é”™è¯¯: ' + e.message, 'error');
                btn.disabled = false;
                btn.innerHTML = 'ğŸ—‘ï¸ é‡è¯•';
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºå½“å‰çŠ¶æ€
        (async function () {
            if ('serviceWorker' in navigator) {
                var regs = await navigator.serviceWorker.getRegistrations();
                log('å½“å‰ Service Worker æ•°é‡: ' + regs.length, 'info');
            }
            if ('caches' in window) {
                var names = await caches.keys();
                log('å½“å‰ç¼“å­˜æ•°é‡: ' + names.length, 'info');
                names.forEach(function (n) { log('  - ' + n, 'info'); });
            }
        })();
    </script>
</body>

</html>